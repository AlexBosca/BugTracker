name: Main CI/CD workflow

on:
  push:
    branches: 
      - master
  pull_request:
    branches: 
      - master

jobs:
  trigger-backend:
    name: Trigger Backend Workflow
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Backend Workflow
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'backend.yml',
              ref: context.ref,
            })

  monitor-backend:
    name: Monitor Backend Workflow
    runs-on: ubuntu-latest
    needs: trigger-backend
    steps:
      - name: Wait for Backend Workflow
        uses: actions/github-script@v5
        with:
          script: |
            const workflowRuns = await github.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'backend.yml',
              branch: context.ref,
              status: 'completed',
              per_page: 1
            });
            if (workflowRuns.data.total_count === 0) {
              core.setFailed('Backend workflow did not run.');
            }
            const latestRun = workflowRuns.data.workflow_runs[0];
            if (latestRun.conclusion !== 'success') {
              core.setFailed(`Backend workflow failed with conclusion: ${latestRun.conclusion}`);
            }

  # build:
  #   runs-on: ubuntu-latest

  #   steps:
  #   - name: Checkout Code
  #     uses: actions/checkout@v4

  #   - name: Set up JDK 17
  #     uses: actions/setup-java@v4
  #     with:
  #       java-version: '17'
  #       distribution: 'oracle'
  #       cache: maven

  #   - name: Test with Maven
  #     run: mvn -f backend test

  #   - name: SonarCloud Scan
  #     run: mvn -f backend verify sonar:sonar -Dsonar.projectKey=ro.alexportfolio:backend -Dsonar.login=${{ secrets.SONAR_TOKEN }}
